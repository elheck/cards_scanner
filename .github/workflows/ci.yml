name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}-dev

jobs:
  build-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

    steps:
    - uses: actions/checkout@v4

    - name: Check for Dockerfile changes
      id: dockerfile-changes
      uses: dorny/paths-filter@v3
      with:
        filters: |
          dockerfile:
            - '.devcontainer/Dockerfile'

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push image
      uses: docker/build-push-action@v5
      id: build
      with:
        context: .
        file: .devcontainer/Dockerfile
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        cache-to: type=inline

  quality:
    runs-on: ubuntu-latest
    needs: build-image
    container:
      image: ${{ needs.build-image.outputs.image }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
    - uses: actions/checkout@v4

    - name: Cache Conan packages
      uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: ${{ runner.os }}-conan-${{ hashFiles('conan-*.lock') }}
        restore-keys: ${{ runner.os }}-conan-

    - name: Setup Conan profile
      run: conan profile detect --force

    - name: Run rebuild.sh
      run: bash ./rebuild.sh

    - name: Run quality checks
      run: bash ./run_quality_tests.sh

  lock-drift:
    runs-on: ubuntu-latest
    needs: [build-image, quality]
    container:
      image: ${{ needs.build-image.outputs.image }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
    - uses: actions/checkout@v4

    - name: Cache Conan packages
      uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: ${{ runner.os }}-conan-${{ hashFiles('conan-*.lock') }}
        restore-keys: ${{ runner.os }}-conan-

    - name: Setup Conan profile
      run: conan profile detect --force

    - name: Check lock drift
      run: |
        set -e
        ARCH_FILE="conan-$(uname -m).lock"
        if [ ! -f "$ARCH_FILE" ]; then
          echo "Missing lockfile: $ARCH_FILE" >&2
          exit 1
        fi
        conan lock create . --lockfile="$ARCH_FILE" --lockfile-out=drift.lock --build=never || {
          echo "Unexpected build attempted (lock incomplete)"
          exit 1
        }
        if ! diff -q "$ARCH_FILE" drift.lock >/dev/null; then
          echo "Lockfile drift detected. Run ./update_lock.sh and commit updated $ARCH_FILE." >&2
          echo "--- Diff (truncated) ---"
          diff -u "$ARCH_FILE" drift.lock | head -n 200 || true
          exit 1
        fi
        echo "No lock drift detected."
