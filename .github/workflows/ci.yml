name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver: docker-container

    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ hashFiles('.devcontainer/Dockerfile') }}
        restore-keys: ${{ runner.os }}-buildx-

    - name: Cache Conan packages
      uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: ${{ runner.os }}-conan-${{ hashFiles('conan-*.lock') }}
        restore-keys: ${{ runner.os }}-conan-

    - name: Build devcontainer image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: .devcontainer/Dockerfile
        tags: card-scanner-dev:latest
        load: true
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

    - name: Move cache
      run: |
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache

    - name: Run rebuild.sh
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -v ~/.conan2:/home/vscode/.conan2 \
          -w /workspace \
          -u vscode \
          card-scanner-dev \
          bash ./rebuild.sh

    - name: Run quality checks
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -v ~/.conan2:/home/vscode/.conan2 \
          -w /workspace \
          -u vscode \
          card-scanner-dev \
          bash ./run_quality_tests.sh

  lock-drift:
    runs-on: ubuntu-latest
    needs: [quality]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver: docker-container

    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ hashFiles('.devcontainer/Dockerfile') }}
        restore-keys: ${{ runner.os }}-buildx-

    - name: Cache Conan packages
      uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: ${{ runner.os }}-conan-${{ hashFiles('conan-*.lock') }}
        restore-keys: ${{ runner.os }}-conan-

    - name: Build devcontainer image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: .devcontainer/Dockerfile
        tags: card-scanner-dev:latest
        load: true
        cache-from: type=local,src=/tmp/.buildx-cache

    - name: Check lock drift
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -v ~/.conan2:/home/vscode/.conan2 \
          -w /workspace \
          -u vscode \
          card-scanner-dev \
          bash -c '
            set -e
            ARCH_FILE="conan-$(uname -m).lock"
            if [ ! -f "$ARCH_FILE" ]; then
              echo "Missing lockfile: $ARCH_FILE" >&2
              exit 1
            fi
            conan lock create . --lockfile="$ARCH_FILE" --lockfile-out=drift.lock --build=never || {
              echo "Unexpected build attempted (lock incomplete)"
              exit 1
            }
            if ! diff -q "$ARCH_FILE" drift.lock >/dev/null; then
              echo "Lockfile drift detected. Run ./update_lock.sh and commit updated $ARCH_FILE." >&2
              echo "--- Diff (truncated) ---"
              diff -u "$ARCH_FILE" drift.lock | head -n 200 || true
              exit 1
            fi
            echo "No lock drift detected."
          '
